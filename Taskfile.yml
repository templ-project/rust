version: "3"

vars:
  # mise dependent
  __TF_MISE_E: "mise trust; mise exec --"
  __TF_MISE_E_PWSH: "mise trust; mise exec -- pwsh -ExecutionPolicy Bypass -Command"
  __TF_MISE_E_PWSH_FILE: "mise trust; mise exec -- pwsh -ExecutionPolicy Bypass -File"
  __TF_MISE_E_UV_RUN: "mise trust; mise exec -- uv run"
  # os dependent

  __TF_VAR_PREFIX:
    sh: |
      echo "{{if eq OS "windows"}}\${{else}}{{end}}"
  __TF_HEADER_LINE: "=============================================================="
  __TF_SEP: " "

  # rust dependent
  RUST_PROJECT_NAME: '{{default .RUST_PROJECT_NAME "rust-template"}}'
  RUST_BUILD_TYPE: '{{default .RUST_BUILD_TYPE "release"}}'
  RUST_BUILD_ARCH: '{{default .RUST_BUILD_ARCH "x86_64"}}'

tasks:
  # ==========================================================================
  # Generic Tasks
  # ==========================================================================

  print:env:
    cmds:
      - cmd: |
          {{.__TF_MISE_E}} env | sort
        platforms: [darwin, linux]
      - cmd: |
          {{.__TF_MISE_E}} {{ .__TF_SEP
            }}pwsh -Command '$BashPath=(Get-Command bash -ErrorAction SilentlyContinue).Path;{{ .__TF_SEP
              }}if ($BashPath) { & $BashPath -c "env | sort" }{{ .__TF_SEP
              }}else { Get-ChildItem "Env:" | Sort-Object Name | ForEach-Object { "$($_.Name)=$($_.Value)" } }'
        platforms: [windows]
    desc: "Print current build environment variables"

  # ==========================================================================
  # Build Tasks
  # ==========================================================================

  build:
    desc: "Build project"
    cmds:
      - cmd: |
          echo "{{.__TF_HEADER_LINE}}"
          echo "Building {{.RUST_PROJECT_NAME}} for {{OS}}/{{ARCH}} in {{.RUST_BUILD_TYPE}} mode"
          echo "{{.__TF_HEADER_LINE}}"
      - task: print:env
      - cmd: |
          {{if eq .RUST_BUILD_TYPE "release"}}
          {{.__TF_MISE_E}} cargo build --release \
            --target {{.RUST_BUILD_ARCH}}-unknown-{{
              if eq OS "windows"}}pc-windows-msvc{{
              else if eq OS "darwin"}}apple-darwin{{
              else}}unknown-linux-gnu{{end}}
          {{else}}
          {{.__TF_MISE_E}} cargo build
          {{end}}
    sources:
      - src/**/*.rs
      - tests/**/*.rs
      - Cargo.toml

  # ============================================================================
  # Clean Tasks
  # ============================================================================

  clean:
    desc: "Clean all build artifacts"
    cmds:
      - |
        rm -rf \
            .coverage \
            .jscpd/html \
            .task \
            coverage \
            target

  # ============================================================================
  # Code Quality Tasks
  # ============================================================================

  format:
    desc: "Format code and fix issues"
    cmds:
      - task: format:cargo
      - task: format:prettier
      - cmd: echo "âœ… Code format completed"

  format:cargo:
    desc: "Format Rust code using rustfmt"
    cmds:
      - cmd: |
          {{.__TF_MISE_E}} cargo fmt --all
      - cmd: echo "âœ… rust code format completed"

  format:prettier:
    cmds:
      - task: prettier
        vars:
          CLI_ARGS: "--write ."
    desc: "Format code using Prettier"
    silent: true

  prettier:
    cmds:
      - |
        {{.__TF_MISE_E}} npx prettier {{.CLI_ARGS}}
      - echo "- âœ… prettier format completed"
    silent: true
    sources:
      - "**/*.{json,md,toml,yaml,yml}"

  format:ruff:
    aliases: [format:py, format:python]
    cmds:
      - task: ruff
        vars:
          CLI_ARGS: "format ."
      - echo "- âœ… ruff format completed"
    desc: "Format Python code using Ruff"
    silent: true

  ruff:
    cmds:
      - |
        {{.__TF_MISE_E_UV_RUN}} ruff {{.CLI_ARGS}}
    desc: "Run Ruff"
    silent: true
    sources:
      - "**/*.py"

  format:check:
    cmds:
      - task: format:check:cargo
      - task: format:check:prettier
      - task: format:check:ruff
      - cmd: echo "âœ… Code format check completed"
    desc: "Check code formatting without fixing"

  format:check:cargo:
    desc: "Check Rust code formatting using rustfmt"
    cmds:
      - cmd: |
          {{.__TF_MISE_E}} cargo fmt --all -- --check
      - cmd: echo "âœ… rust code format check completed"

  format:check:prettier:
    cmds:
      - task: prettier
        vars:
          CLI_ARGS: "--check ."
      - echo "- âœ… prettier format check completed"
    desc: "Check code formatting using Prettier"
    silent: true

  format:check:ruff:
    aliases: [format:check:py, format:check:python]
    cmds:
      - task: ruff
        vars:
          CLI_ARGS: "format --check ."
      - echo "- âœ… ruff format check completed"
    desc: "Check Python code formatting using Ruff"
    silent: true

  lint:
    desc: "Run linter and fix issues"
    cmds:
      - task: lint:cargo
      - task: lint:eslint
      - task: lint:pylint
      - task: lint:pwshlint
      - task: lint:shlint
      - cmd: echo "âœ… Linting completed"

  lint:cargo:
    cmds:
      - task: cargo-clippy
        vars:
          CLI_ARGS: "--fix"
      - echo "- âœ… cargo lint completed"

  cargo-clippy:
    cmds:
      - cmd: |
          {{.__TF_MISE_E}} cargo clippy --all-features --allow-dirty --verbose {{.CLI_ARGS}} -- \
            -W clippy::all \
            -W clippy::pedantic \
            -A clippy::module-name-repetitions \
            -A clippy::missing-const-for-fn \
            -D warnings
    desc: "Run cargo clippy linter"
    silent: true
    sources:
      - src/**/*.rs
      - tests/**/*.rs
      - Cargo.toml

  lint:eslint:
    cmds:
      - task: eslint
        vars:
          CLI_ARGS: "--fix ."
      - echo "- âœ… eslint lint completed"
    desc: "Lint code using ESLint"
    silent: true

  eslint:
    cmds:
      - |
        {{.__TF_MISE_E}} npx eslint {{.CLI_ARGS}}
    desc: "Run ESLint"
    silent: true
    sources:
      - "**/*.{json,md,toml,yaml,yml}"

  lint:pylint:
    aliases: [lint:py, lint:python]
    cmds:
      - task: pylint
        vars:
          CLI_ARGS: "."
      - echo "- âœ… pylint lint completed"
    desc: "Lint Python scripts using pylint"
    silent: true

  pylint:
    cmds:
      - |
        {{.__TF_MISE_E_UV_RUN}} pylint {{.CLI_ARGS}}
    desc: "Run pylint"
    silent: true
    sources:
      - "**/*.py"

  lint:pwshlint:
    aliases: [lint:pwsh]
    cmds:
      - task: pwshlint_py
        vars:
          CLI_ARGS: "--fix"
      - echo "- âœ… pwsh lint completed"
    desc: "Lint PowerShell scripts using PSScriptAnalyzer"
    silent: true

  pwshlint_py:
    cmds:
      - |
        {{.__TF_MISE_E_UV_RUN}} .scripts/pwshlint.py {{.CLI_ARGS}}
    desc: "Run PSScriptAnalyzer"
    silent: true
    sources:
      - "**/*.ps1"

  lint:shlint:
    aliases: [lint:sh, lint:bash]
    cmds:
      - task: shlint_py
        vars:
          CLI_ARGS: "--fix"
      - echo "- âœ… bash lint completed"
    desc: "Lint shell scripts using ShellCheck"
    silent: true

  shlint_py:
    cmds:
      - cmd: |
          {{.__TF_MISE_E}} python .scripts/shlint.py {{.CLI_ARGS}}
        platforms: [darwin, linux, windows]
    desc: "Run ShellCheck"
    silent: true
    sources:
      - "**/*.sh"

  lint:check:
    desc: "Run linter without fixing"
    cmds:
      - task: lint:check:cargo
      - task: lint:check:eslint
      - task: lint:check:pylint
      - task: lint:check:pwshlint
      - task: lint:check:shlint
      - cmd: echo "âœ… Linting check completed"

  lint:check:cargo:
    cmds:
      - task: cargo-clippy
      - echo "- âœ… cargo lint check completed"

  lint:check:eslint:
    cmds:
      - task: eslint
        vars:
          CLI_ARGS: "."
      - echo "- âœ… eslint lint check completed"
    desc: "Check code using ESLint"
    silent: true

  lint:check:pylint:
    aliases: [lint:check:py, lint:check:python]
    cmds:
      - task: lint:pylint
      - echo "- âœ… pylint lint check completed"
    desc: "Check Python scripts using pylint"
    silent: true

  lint:check:pwshlint:
    aliases: [lint:check:pwsh]
    cmds:
      - task: pwshlint_py
      - echo "- âœ… pwsh lint completed"
    desc: "Check PowerShell scripts using PSScriptAnalyzer"
    silent: true

  lint:check:shlint:
    aliases: [lint:check:sh, lint:check:bash]
    cmds:
      - task: shlint_py
      - echo "- âœ… bash lint completed"
    desc: "Check shell scripts using ShellCheck"
    silent: true

  lint-staged:
    desc: "Run linter on staged files and fix issues"
    cmds:
      - |
        {{.__TF_MISE_E}} npx -y lint-staged
    silent: true

  audit-check:
    desc: "Check for security vulnerabilities in dependencies"
    cmds:
      - |
        echo "ğŸ”’ Checking for security vulnerabilities..."
        {{.__TF_MISE_E}} cargo audit

  duplicate-check:
    cmds:
      - |
        {{.__TF_MISE_E}} npm run duplicate-check
      - git add .jscpd/jscpd-badge.svg 2>/dev/null || true
    desc: "Check for duplicate code using jscpd"

  license-check:
    desc: "Check license compliance and security advisories"
    cmds:
      - |
        echo "ğŸ“‹ Checking licenses and advisories..."
        {{.__TF_MISE_E}} cargo deny check

  # ============================================================================
  # Test Tasks
  # ============================================================================

  test:
    desc: "Run tests with coverage"
    cmds:
      - task: build
        vars:
          RUST_BUILD_TYPE: "debug"
      - cmd: |
          {{.__TF_MISE_E}} cargo test --all-features
      - task: test:gen-coverage

  test:gen-coverage:
    desc: "Generate coverage report"
    cmds:
      - |
        echo ""
        echo "ğŸ“Š Generating coverage report..."
        echo "ğŸ“Š Running tests with coverage..."
        {{.__TF_MISE_E}} cargo tarpaulin --out Html --out Lcov --out Stdout --output-dir .coverage --exclude-files "tests/*" --all-features
        echo ""
        if [ -f ".coverage/index.html" ]; then
          echo "âœ… HTML coverage report: .coverage/index.html"
        fi
        if [ -f ".coverage/lcov.info" ]; then
          echo "âœ… LCOV coverage data: .coverage/lcov.info"
        fi
        echo ""
    silent: true

  # ============================================================================
  # Development Tools
  # ============================================================================

  run:
    desc: "Run application"
    deps:
      - task: build
        vars:
          RUST_BUILD_TYPE: "debug"
    cmds:
      - |
        echo "ğŸƒ Running application..."
        {{.__TF_MISE_E}} cargo run

  debug:
    desc: "Run application with debugger (gdb/lldb)"
    cmds:
      - task: build
        vars:
          RUST_BUILD_TYPE: "debug"
      - cmd: |
          {{if eq OS "windows"}}
          echo "âš ï¸ CLI debugging not supported on Windows."
          echo "â„¹ï¸ Please use Visual Studio Code or your IDE's debugger instead."
          echo ""
          echo "Alternatively, install gdb via MSYS2 and run manually:"
          echo "gdb target/debug/{{.RUST_PROJECT_NAME}}.exe"
          exit 0
          {{else}}
          if command -v lldb >/dev/null 2>&1; then
            echo "ğŸ› Starting lldb debugger..."
            lldb target/debug/{{.RUST_PROJECT_NAME}}
          elif command -v gdb >/dev/null 2>&1; then
            echo "ğŸ› Starting gdb debugger..."
            gdb target/debug/{{.RUST_PROJECT_NAME}}
          else
            echo "âš ï¸ No debugger found. Please install gdb or lldb."
            exit 1
          fi
          {{end}}

  # ============================================================================
  # Documentation Tasks
  # ============================================================================

  docs:
    desc: "Build documentation"
    cmds:
      - |
        {{.__TF_MISE_E}} cargo doc --no-deps --all-features

  docs:serve:
    desc: "Serve documentation locally with live reload"
    cmds:
      - |
        {{.__TF_MISE_E}} cargo doc --open --no-deps --all-features

  # ============================================================================
  # Validation Tasks
  # ============================================================================

  validate:
    cmds:
      - task: format
      - task: clean
      - task: build
      - task: lint
      - task: run
      - task: clean
      - task: test
      - task: docs
      - cmd: |
          echo ""
          echo "{{.__TF_HEADER_LINE}}"
          echo "âœ… Validation successful"
          echo "{{.__TF_HEADER_LINE}}"
          echo ""
    desc: "Run CI pipeline for specific build system and compiler"
    silent: true
  # ============================================================================
  # Dependencies
  # ============================================================================

  deps:clean:
    cmds:
      - task: deps:clean:mise
      - task: deps:clean:cargo
      - task: deps:clean:npm
      - task: deps:clean:uv
    desc: "Clean all project dependencies"

  deps:clean:mise:
    cmds:
      - echo "ğŸ§¹ Cleaning Mise dependencies..."
      - cmd: rm -rf ~/.local/share/mise/installs
        platforms: [darwin, linux]
      - cmd: |
          {{.__TF_MISE_E_PWSH}} 'Remove-Item -Recurse -Force $env:LOCALAPPDATA\mise\installs\*'
        platforms: [windows]
      - cmd: rm -rf .mise.lock .mise.local.lock
      - echo "âœ“ Mise environment cleaned"
    desc: "Clean Mise dependencies"

  deps:clean:cargo:
    cmds:
      - |
        echo "ğŸ§¹ Cleaning Cargo dependencies..."
        rm -rf Cargo.lock target
        echo "âœ“ Cargo environment cleaned"
    desc: "Clean Cargo dependencies"

  deps:clean:npm:
    cmds:
      - |
        echo "ğŸ§¹ Cleaning NodeJs dependencies..."
        rm -rf node_modules package-lock.json
        echo "âœ“ NodeJs environment cleaned"
    desc: "Clean NodeJs dependencies"

  deps:clean:uv:
    cmds:
      - |
        echo "ğŸ§¹ Cleaning Python dependencies..."
        rm -rf .venv uv.lock
        echo "âœ“ Python environment cleaned"
    desc: "Clean Python dependencies"

  deps:sync:
    cmds:
      - task: deps:sync:mise
      - task: deps:sync:cargo
      - task: deps:sync:npm
      - task: deps:sync:uv
    desc: "Install all project dependencies"

  deps:sync:mise:
    cmds:
      - |
        echo "ğŸ“¦ Installing Mise dependencies..."
        if [ ! -f .mise.local.toml ] && [ ! -f .mise.lock ]; then
          echo "âš ï¸  .mise.local.toml not found; sync won't generate .mise.lock automatically."
          echo "Please create a .mise.local.toml file or a .mise.lock file to proceed."
          echo ""
          echo "[settings]"
          echo "experimental = true"
          echo "lockfile = true"
          echo ""
          exit 1
        fi
        mise trust && mise install --yes
        echo "âœ“ Mise environment ready"
    desc: "Install Mise dependencies"

  deps:sync:cargo:
    cmds:
      - |
        echo "ğŸ“¦ Installing Cargo dependencies..."
        {{.__TF_MISE_E}} cargo fetch
        {{.__TF_MISE_E}} cargo install --force cargo-tarpaulin cargo-deny cargo-audit
        echo "âœ“ Cargo environment ready"
    desc: "Install Cargo dependencies"

  deps:sync:npm:
    cmds:
      - |
        echo "ğŸ“¦ Installing NodeJs dependencies..."
        {{.__TF_MISE_E}} npm install
        {{.__TF_MISE_E}} npx husky
        echo "âœ“ NodeJs environment ready"
    desc: "Install NodeJs dependencies"

  deps:sync:uv:
    cmds:
      - |
        echo "ğŸ“¦ Installing Python dependencies..."
        {{.__TF_MISE_E}} uv sync
        echo "âœ“ Python environment ready"
    desc: "Install Python dependencies"

  deps:refresh:
    cmds:
      - task: deps:refresh:mise
      - task: deps:refresh:cargo
      - task: deps:refresh:npm
    desc: "Refresh all project dependencies"

  deps:refresh:mise:
    cmds:
      - |
        echo "ğŸ”„ Refreshing Mise packages..."
        mise upgrade
        echo "âœ“ Packages refreshed"
    desc: "Refresh all Mise packages (update dependencies)"

  deps:refresh:cargo:
    cmds:
      - |
        echo "ğŸ”„ Refreshing Cargo packages..."
        {{.__TF_MISE_E}} cargo update
        {{.__TF_MISE_E}} cargo install --force cargo-tarpaulin cargo-deny cargo-audit
        echo "âœ“ Packages refreshed"
    desc: "Refresh all Cargo packages (update dependencies)"

  deps:refresh:npm:
    cmds:
      - |
        echo "ğŸ”„ Refreshing NodeJs packages..."
        {{.__TF_MISE_E}} npm outdated \
          && {{.__TF_MISE_E}} npm update \
          && {{.__TF_MISE_E}} npm audit fix
        echo "âœ“ Packages refreshed"
    desc: "Refresh all NodeJs packages (update dependencies)"

  deps:refresh:uv:
    cmds:
      - |
        echo "ğŸ”„ Refreshing Python packages..."
        {{.__TF_MISE_E}} uv sync --upgrade
        echo "âœ“ Packages refreshed"
    desc: "Refresh all Python packages (update dependencies)"
