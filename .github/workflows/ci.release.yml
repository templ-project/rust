name: CI Â» Release

on:
  workflow_call:
    inputs:
      tag:
        description: Tag for the release (e.g., v1.2.3)
        required: true
        type: string
      prerelease:
        description: Mark as pre-release
        required: false
        type: boolean
        default: false
  workflow_dispatch:
    inputs:
      tag:
        description: Tag for the release (e.g., v1.2.3)
        required: true
        type: string
      prerelease:
        description: Mark as pre-release
        required: false
        type: boolean
        default: false

jobs:
  # Define build matrix
  matrix:
    name: Define Matrix
    runs-on: ubuntu-latest
    outputs:
      runners: ${{ steps.set-matrix.outputs.runners }}
    steps:
      - name: Set matrix
        id: set-matrix
        run: |
          echo 'runners=[
            "ubuntu-latest",
            "macos-latest",
            "windows-latest"
          ]' | tr -d '\n' | tr -s ' ' >> $GITHUB_OUTPUT

  # Build for all platforms
  build:
    name: Build (${{ matrix.runner }})
    needs: [matrix]
    strategy:
      matrix:
        runner: ${{ fromJson(needs.matrix.outputs.runners) }}
    uses: ./.github/workflows/ci.quality.yml
    permissions:
      contents: write
    with:
      runs-on: ${{ matrix.runner }}
      jobs: build

  # Publish the release
  release:
    name: Publish Release
    runs-on: ubuntu-latest
    needs: [build]
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.tag }}
          fetch-depth: 0

      - name: Download all build artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: build-*
          path: release-assets
          merge-multiple: true

      - name: List release assets
        run: |
          echo "Release assets:"
          ls -lah release-assets/

      - name: Read changelog
        run: |
          if [ -f CHANGELOG.md ]; then
            echo "Using generated CHANGELOG.md"
          else
            echo "Release ${{ inputs.tag }}" > CHANGELOG.md
          fi

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.tag }}
          name: Release ${{ inputs.tag }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: ${{ inputs.prerelease }}
          files: release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
