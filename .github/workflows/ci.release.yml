name: CI » Release

on:
  workflow_call:
    inputs:
      tag:
        description: 'Tag for the release (e.g., v1.2.3)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false
      runs-on:
        description: 'Operating system runner'
        required: false
        type: string
        default: 'ubuntu-latest'
      target:
        description: 'Rust target triple'
        required: false
        type: string
        default: 'x86_64-unknown-linux-gnu'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag for the release (e.g., v1.2.3)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false
      runs-on:
        description: 'Operating system runner'
        required: false
        type: string
        default: 'ubuntu-latest'
      target:
        description: 'Rust target triple'
        required: false
        type: string
        default: 'x86_64-unknown-linux-gnu'
      skip_validation:
        description: 'Skip build validation before release'
        required: false
        type: boolean
        default: false

jobs:
  # Optional validation when manually triggered (includes build for artifact)
  quality:
    name: Quality
    if: github.event_name == 'workflow_dispatch' && !inputs.skip_validation
    uses: ./.github/workflows/ci.quality.yml
    with:
      runs-on: ${{ inputs.runs-on }}
      target: ${{ inputs.target }}
      jobs: build,lint,test

  release:
    runs-on: ubuntu-latest
    needs: [quality]
    if: always() && (needs.quality.result == 'success' || needs.quality.result == 'skipped')
    permissions:
      contents: write
    steps:
      - name: Debug inputs
        run: |
          echo "tag = ${{ inputs.tag }}"
          echo "prerelease = ${{ inputs.prerelease }}"
          echo "runs-on = ${{ inputs.runs-on }}"
          echo "target = ${{ inputs.target }}"

      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.tag }}
          fetch-depth: 0

      - name: Read changelog
        id: changelog
        run: |
          if [ -f CHANGELOG.md ]; then
            echo "Using generated CHANGELOG.md from bumpalicious"
          else
            echo "CHANGELOG.md not found, will use tag as body"
            echo "Release ${{ inputs.tag }}" > CHANGELOG.md
          fi

      - name: Download build artifact
        uses: actions/download-artifact@v4
        continue-on-error: true
        id: download-artifact
        with:
          name: build-${{ inputs.target }}
          path: build-artifacts

      - name: Build if artifact not found
        if: steps.download-artifact.outcome == 'failure'
        run: |
          echo "::notice::⚠️ No artifact found, building release binary..."
        shell: bash

      - name: Setup tools for fallback build
        if: steps.download-artifact.outcome == 'failure'
        uses: ./.github/actions/setup-tools

      - name: Fallback build
        if: steps.download-artifact.outcome == 'failure'
        run: |
          rustup target add ${{ inputs.target }}
          task build RUST_BUILD_TARGET=${{ inputs.target }}
          mkdir -p build-artifacts
          cp target/${{ inputs.target }}/release/rust-template build-artifacts/ 2>/dev/null || true
          cp target/${{ inputs.target }}/release/rust-template.exe build-artifacts/ 2>/dev/null || true
        shell: bash

      - name: List downloaded artifacts
        run: |
          echo "Downloaded artifacts:"
          find build-artifacts -type f | head -50

      - name: Create distribution package
        run: |
          mkdir -p release-assets

          TARGET="${{ inputs.target }}"
          echo "Processing target: $TARGET"

          # Find the binary (rust-template or rust-template.exe)
          BINARY=$(find build-artifacts -type f \( -name 'rust-template' -o -name 'rust-template.exe' \) | head -1)

          if [ -z "$BINARY" ]; then
            echo "No binary found in build-artifacts"
            exit 1
          fi

          FILENAME=$(basename "$BINARY")
          echo "Found binary: $BINARY"

          # Extract OS and ARCH from target triple (e.g., x86_64-unknown-linux-gnu -> linux, x86_64)
          ARCH=$(echo "$TARGET" | cut -d'-' -f1)
          if [[ "$TARGET" == *"linux"* ]]; then
            OS="linux"
          elif [[ "$TARGET" == *"darwin"* ]]; then
            OS="darwin"
          elif [[ "$TARGET" == *"windows"* ]]; then
            OS="windows"
          else
            OS="unknown"
          fi

          # Determine archive type based on target
          if [[ "$TARGET" == *"windows"* ]]; then
            ARCHIVE_NAME="release-assets/rust-template_${OS}_${ARCH}.zip"
            zip -j "$ARCHIVE_NAME" "$BINARY"
            echo "Created archive: $ARCHIVE_NAME"
          else
            ARCHIVE_NAME="release-assets/rust-template_${OS}_${ARCH}.tar.gz"
            tar -czf "$ARCHIVE_NAME" -C "$(dirname "$BINARY")" "$FILENAME"
            echo "Created archive: $ARCHIVE_NAME"
          fi

          echo ""
          echo "Release assets created:"
          ls -lah release-assets/

      - name: Upload release asset to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.tag }}
          name: Release ${{ inputs.tag }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: ${{ inputs.prerelease }}
          files: release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
