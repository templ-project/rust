name: CI Â» Release

on:
  workflow_call:
    inputs:
      tag:
        description: 'Tag for the release (e.g., v1.2.3)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false
      runs-on:
        description: 'Operating system runner'
        required: false
        type: string
        default: 'ubuntu-latest'
      target:
        description: 'Rust target triple'
        required: false
        type: string
        default: 'x86_64-unknown-linux-gnu'
      draft_tag:
        description: 'Draft release tag to download assets from (e.g., draft-abc123)'
        required: false
        type: string
        default: ''
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag for the release (e.g., v1.2.3)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false
      runs-on:
        description: 'Operating system runner'
        required: false
        type: string
        default: 'ubuntu-latest'
      target:
        description: 'Rust target triple'
        required: false
        type: string
        default: 'x86_64-unknown-linux-gnu'
      skip_validation:
        description: 'Skip build validation before release'
        required: false
        type: boolean
        default: false
      draft_tag:
        description: 'Draft release tag to download assets from (e.g., draft-abc123)'
        required: false
        type: string
        default: ''

jobs:
  # Optional validation when manually triggered (includes build for artifact)
  quality:
    name: Quality
    if: github.event_name == 'workflow_dispatch' && !inputs.skip_validation
    uses: ./.github/workflows/ci.quality.yml
    with:
      runs-on: ${{ inputs.runs-on }}
      target: ${{ inputs.target }}
      jobs: build,lint,test

  release:
    runs-on: ubuntu-latest
    needs: [quality]
    if: always() && (needs.quality.result == 'success' || needs.quality.result == 'skipped')
    permissions:
      contents: write
    steps:
      - name: Debug inputs
        run: |
          echo "tag = ${{ inputs.tag }}"
          echo "prerelease = ${{ inputs.prerelease }}"
          echo "runs-on = ${{ inputs.runs-on }}"
          echo "target = ${{ inputs.target }}"

      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.tag }}
          fetch-depth: 0

      - name: Read changelog
        id: changelog
        run: |
          if [ -f CHANGELOG.md ]; then
            echo "Using generated CHANGELOG.md from bumpalicious"
          else
            echo "CHANGELOG.md not found, will use tag as body"
            echo "Release ${{ inputs.tag }}" > CHANGELOG.md
          fi

      - name: Find draft release
        id: find-draft
        run: |
          DRAFT_TAG="${{ inputs.draft_tag }}"

          if [ -n "$DRAFT_TAG" ]; then
            echo "Using provided draft tag: $DRAFT_TAG"
            echo "draft_tag=$DRAFT_TAG" >> $GITHUB_OUTPUT
            echo "found=true" >> $GITHUB_OUTPUT
          else
            # Find the most recent draft release with our prefix
            echo "Searching for draft releases..."
            DRAFT=$(gh release list --limit 50 | grep -E "^draft-.*Draft" | head -1 | awk '{print $1}' || true)

            if [ -n "$DRAFT" ]; then
              echo "Found draft release: $DRAFT"
              echo "draft_tag=$DRAFT" >> $GITHUB_OUTPUT
              echo "found=true" >> $GITHUB_OUTPUT
            else
              echo "No draft release found"
              echo "found=false" >> $GITHUB_OUTPUT
            fi
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Parse target
        id: target
        uses: ./.github/actions/parse-target
        with:
          target: ${{ inputs.target }}

      - name: Download assets from draft release
        id: download-draft
        if: steps.find-draft.outputs.found == 'true'
        run: |
          mkdir -p release-assets
          DRAFT_TAG="${{ steps.find-draft.outputs.draft_tag }}"
          PATTERN="rust-template_${{ steps.target.outputs.os }}_${{ steps.target.outputs.arch }}.*"

          echo "Looking for: $PATTERN"

          gh release download "$DRAFT_TAG" \
            --dir release-assets \
            --pattern "$PATTERN"

          echo "Downloaded assets:"
          ls -la release-assets/
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Fail if no draft release found
        if: steps.find-draft.outputs.found != 'true'
        run: |
          echo "::error::No draft release found. Build artifacts are missing."
          echo "Please ensure the build workflow completed successfully before releasing."
          exit 1

      - name: List release assets
        run: |
          echo "Release assets:"
          ls -lah release-assets/

      - name: Upload release asset to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.tag }}
          name: Release ${{ inputs.tag }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: ${{ inputs.prerelease }}
          files: release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
