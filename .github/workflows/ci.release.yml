name: CI Â» Release

on:
  workflow_call:
    inputs:
      tag:
        description: 'Tag for the release (e.g., v1.2.3)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag for the release (e.g., v1.2.3)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false
      skip_validation:
        description: 'Skip build validation before release'
        required: false
        type: boolean
        default: false

jobs:
  # Optional validation when manually triggered
  validate:
    if: github.event_name == 'workflow_dispatch' && !inputs.skip_validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag }}
      - uses: ./.github/actions/setup-tools

      - name: Lint Code
        run: |
          task lint
        shell: bash

      - name: Test Code
        run: |
          task test
        shell: bash

  release:
    runs-on: ubuntu-latest
    needs: [validate]
    if: always() && (needs.validate.result == 'success' || needs.validate.result == 'skipped')
    permissions:
      contents: write
    steps:
      - name: Debug inputs.prerelease
        run: |
          echo "tag = ${{ inputs.tag }}"
          echo "prerelease = ${{ inputs.prerelease }}"

      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.tag }}
          fetch-depth: 0

      - name: Read changelog
        id: changelog
        run: |
          if [ -f CHANGELOG.md ]; then
            echo "Using generated CHANGELOG.md from bumpalicious"
          else
            echo "CHANGELOG.md not found, will use tag as body"
            echo "Release ${{ inputs.tag }}" > CHANGELOG.md
          fi

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: build-artifacts
          pattern: build-*

      - name: List downloaded artifacts
        run: |
          echo "Downloaded artifacts:"
          find build-artifacts -type f | head -50

      - name: Create distribution packages
        run: |
          mkdir -p release-assets

          # Get project name from Cargo.toml
          PROJECT_NAME=$(grep '^name' Cargo.toml | head -1 | sed 's/.*= *"\([^"]*\)".*/\1/')
          echo "Project name: $PROJECT_NAME"

          # Package Linux x86_64 artifact
          if [ -d "build-artifacts/build-ubuntu-latest-x86_64" ]; then
            echo "ðŸ“¦ Packaging Linux x86_64..."
            cd build-artifacts/build-ubuntu-latest-x86_64
            # Find the binary (exclude .d files and other non-executables)
            BINARY=$(find . -type f -executable -name "$PROJECT_NAME" 2>/dev/null || find . -type f ! -name "*.d" ! -name "*.rlib" | head -1)
            if [ -n "$BINARY" ]; then
              chmod +x "$BINARY" 2>/dev/null || true
              tar -czf "../../release-assets/${PROJECT_NAME}-${{ inputs.tag }}-x86_64-unknown-linux-gnu.tar.gz" \
                  -C "$(dirname "$BINARY")" "$(basename "$BINARY")"
              echo "âœ“ Created Linux x86_64 artifact"
            else
              echo "âš  No binary found for Linux x86_64"
            fi
            cd ../..
          else
            echo "âš  Linux x86_64 build not found"
          fi

          # Package macOS aarch64 artifact
          if [ -d "build-artifacts/build-macos-latest-aarch64" ]; then
            echo "ðŸ“¦ Packaging macOS aarch64..."
            cd build-artifacts/build-macos-latest-aarch64
            BINARY=$(find . -type f -name "$PROJECT_NAME" 2>/dev/null || find . -type f ! -name "*.d" ! -name "*.rlib" | head -1)
            if [ -n "$BINARY" ]; then
              chmod +x "$BINARY" 2>/dev/null || true
              tar -czf "../../release-assets/${PROJECT_NAME}-${{ inputs.tag }}-aarch64-apple-darwin.tar.gz" \
                  -C "$(dirname "$BINARY")" "$(basename "$BINARY")"
              echo "âœ“ Created macOS aarch64 artifact"
            else
              echo "âš  No binary found for macOS aarch64"
            fi
            cd ../..
          else
            echo "âš  macOS aarch64 build not found"
          fi

          # Package Windows x86_64 artifact
          if [ -d "build-artifacts/build-windows-latest-x86_64" ]; then
            echo "ðŸ“¦ Packaging Windows x86_64..."
            cd build-artifacts/build-windows-latest-x86_64
            BINARY=$(find . -type f -name "${PROJECT_NAME}.exe" 2>/dev/null || find . -type f -name "*.exe" | head -1)
            if [ -n "$BINARY" ]; then
              zip -j "../../release-assets/${PROJECT_NAME}-${{ inputs.tag }}-x86_64-pc-windows-msvc.zip" "$BINARY"
              echo "âœ“ Created Windows x86_64 artifact"
            else
              echo "âš  No binary found for Windows x86_64"
            fi
            cd ../..
          else
            echo "âš  Windows x86_64 build not found"
          fi

          echo ""
          echo "Release assets created:"
          ls -lah release-assets/ || echo "No release assets created"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.tag }}
          name: Release ${{ inputs.tag }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: ${{ inputs.prerelease }}
          files: release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
